# ===============================================
# ImmoGuin√©e - Minimal Development Configuration
# For Apple Silicon (ARM64) Macs
# ===============================================
# Usage: docker compose -f docker-compose.dev.yml up -d
# ===============================================

networks:
  dev-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:

secrets:
  app_key:
    file: ./secrets/app_key
  passport_private_key:
    file: ./secrets/passport_private_key
  passport_public_key:
    file: ./secrets/passport_public_key
  passport_client_id:
    file: ./secrets/passport_personal_access_client_id
  passport_client_secret:
    file: ./secrets/passport_personal_access_client_secret
  db_password:
    file: ./secrets/db_password
  redis_password:
    file: ./secrets/redis_password
  facebook_app_id:
    file: ./secrets/facebook_app_id
  facebook_app_secret:
    file: ./secrets/facebook_app_secret

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    hostname: postgres
    environment:
      POSTGRES_DB: immog_db
      POSTGRES_USER: immog_user
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
      PGDATA: /var/lib/postgresql/data/pgdata
    secrets:
      - db_password
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5433:5432"
    networks:
      - dev-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U immog_user -d immog_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    hostname: redis
    command: sh -c 'redis-server --appendonly yes --requirepass "$$(cat /run/secrets/redis_password)"'
    secrets:
      - redis_password
    volumes:
      - redis-data:/data
    ports:
      - "127.0.0.1:6379:6379"
    networks:
      - dev-network
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a $$(cat /run/secrets/redis_password) ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PHP Backend (Laravel)
  php:
    build:
      context: ../backend
      dockerfile: ../docker/php/Dockerfile
    image: immoguinee/php:dev
    hostname: php
    working_dir: /var/www/backend
    volumes:
      - ../backend:/var/www/backend
      - ./php/php.ini:/usr/local/etc/php/php.ini:ro
    secrets:
      - app_key
      - passport_private_key
      - passport_public_key
      - passport_client_id
      - passport_client_secret
      - db_password
      - redis_password
      - facebook_app_id
      - facebook_app_secret
    environment:
      - APP_ENV=local
      - APP_DEBUG=true
      - APP_KEY_FILE=/run/secrets/app_key
      - DB_CONNECTION=pgsql
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_DATABASE=immog_db
      - DB_USERNAME=immog_user
      - DB_PASSWORD_FILE=/run/secrets/db_password
      - REDIS_HOST=redis
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - REDIS_PORT=6379
      - CACHE_STORE=redis
      - SESSION_DRIVER=redis
      - QUEUE_CONNECTION=redis
      - SCOUT_DRIVER=collection
      - STORAGE_STRATEGY=local
      - PASSPORT_PERSONAL_ACCESS_CLIENT_ID_FILE=/run/secrets/passport_client_id
      - PASSPORT_PERSONAL_ACCESS_CLIENT_SECRET_FILE=/run/secrets/passport_client_secret
      - FACEBOOK_APP_ID_FILE=/run/secrets/facebook_app_id
      - FACEBOOK_APP_SECRET_FILE=/run/secrets/facebook_app_secret
    networks:
      - dev-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # Nginx Web Server
  nginx:
    image: nginx:1.27-alpine
    hostname: nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/sites:/etc/nginx/conf.d:ro
      - ../backend/public:/var/www/backend/public:ro
      - ../backend/storage/app/public:/var/www/backend/storage/app/public:ro
    ports:
      - "8000:80"
    networks:
      - dev-network
    depends_on:
      - php

  # Queue Worker
  queue-worker:
    build:
      context: ../backend
      dockerfile: ../docker/php/Dockerfile
    image: immoguinee/php:dev
    hostname: queue-worker
    working_dir: /var/www/backend
    command: php artisan queue:work redis --sleep=3 --tries=3 --max-time=3600
    volumes:
      - ../backend:/var/www/backend
    secrets:
      - app_key
      - db_password
      - redis_password
      - facebook_app_id
      - facebook_app_secret
    environment:
      - APP_ENV=local
      - APP_KEY_FILE=/run/secrets/app_key
      - DB_CONNECTION=pgsql
      - DB_HOST=postgres
      - DB_DATABASE=immog_db
      - DB_USERNAME=immog_user
      - DB_PASSWORD_FILE=/run/secrets/db_password
      - REDIS_HOST=redis
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - FACEBOOK_APP_ID_FILE=/run/secrets/facebook_app_id
      - FACEBOOK_APP_SECRET_FILE=/run/secrets/facebook_app_secret
    networks:
      - dev-network
    depends_on:
      - php

  # Frontend (Next.js)
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile.dev
    image: immoguinee/frontend:dev
    hostname: frontend
    volumes:
      - ../frontend:/app
      - /app/node_modules
      - /app/.next
    ports:
      - "3006:3005"
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=http://localhost:8000/api
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
    command: npm run dev
    networks:
      - dev-network
