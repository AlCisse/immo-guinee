# ===============================================
# Production Override Configuration (Docker Swarm)
# Usage: docker stack deploy -c docker-compose.yml -c docker-compose.prod.yml immog
# ===============================================

services:
  # Frontend - Production standalone build
  frontend:
    image: immoguinee/frontend:latest
    environment:
      - NODE_ENV=production
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.frontend.rule=Host(`immoguinee.com`) || Host(`www.immoguinee.com`)"
        - "traefik.http.routers.frontend.entrypoints=websecure"
        - "traefik.http.routers.frontend.tls=true"
        - "traefik.http.routers.frontend.priority=1"
        - "traefik.http.services.frontend.loadbalancer.server.port=3000"

  # PHP - Production
  php:
    image: immoguinee/php:latest
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback

  # Nginx - Production with Traefik labels
  nginx:
    deploy:
      replicas: 2
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.api.rule=(Host(`immoguinee.com`) || Host(`www.immoguinee.com`)) && PathPrefix(`/api`)"
        - "traefik.http.routers.api.entrypoints=websecure"
        - "traefik.http.routers.api.tls=true"
        - "traefik.http.routers.api.priority=100"
        - "traefik.http.services.api.loadbalancer.server.port=80"

  # Queue Worker - Production
  queue-worker:
    image: immoguinee/php:latest
    environment:
      - APP_ENV=production
    deploy:
      replicas: 2

  # Scheduler - Production (only 1 replica needed)
  scheduler:
    image: immoguinee/php:latest
    environment:
      - APP_ENV=production
    deploy:
      replicas: 1

  # n8n - Production URLs
  n8n:
    environment:
      - N8N_PROTOCOL=https
      - N8N_HOST=automate.immoguinee.com
      - WEBHOOK_URL=https://automate.immoguinee.com/
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.n8n.rule=Host(`automate.immoguinee.com`)"
        - "traefik.http.routers.n8n.entrypoints=websecure"
        - "traefik.http.routers.n8n.tls=true"
        - "traefik.http.services.n8n.loadbalancer.server.port=5678"

  # WAHA - Production with external port for webhooks
  waha:
    ports:
      - "3000:3000"
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.waha.rule=Host(`waha.immoguinee.com`)"
        - "traefik.http.routers.waha.entrypoints=websecure"
        - "traefik.http.routers.waha.tls=true"
        - "traefik.http.services.waha.loadbalancer.server.port=3000"

  # Grafana - Production
  grafana:
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.grafana.rule=Host(`monitoring.immoguinee.com`)"
        - "traefik.http.routers.grafana.entrypoints=websecure"
        - "traefik.http.routers.grafana.tls=true"
        - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  # MinIO - Production
  minio:
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.minio.rule=Host(`minio.immoguinee.com`)"
        - "traefik.http.routers.minio.entrypoints=websecure"
        - "traefik.http.routers.minio.tls=true"
        - "traefik.http.services.minio.loadbalancer.server.port=9001"

  # Traefik - Production ports (80/443)
  traefik:
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.traefik.rule=Host(`traefik.immoguinee.com`)"
        - "traefik.http.routers.traefik.entrypoints=websecure"
        - "traefik.http.routers.traefik.tls=true"
        - "traefik.http.routers.traefik.service=api@internal"
