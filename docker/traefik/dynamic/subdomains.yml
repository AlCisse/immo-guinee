# ===============================================
# Subdomains Configuration - immoguinee.com
# Routes for admin tools: grafana, pgadmin, traefik, prometheus, alertmanager
# Docker Swarm service names use immo_ prefix
# SECURED: Cloudflare-only access + BasicAuth (admin-auth middleware)
# INTERNAL ONLY: waha, n8n, minio (no web access - backend use only)
# ===============================================

http:
  routers:
    # =============================================
    # INTERNAL SERVICES - NO WEB ACCESS
    # These services are only accessible from within Docker network
    # =============================================

    # n8n - REMOVED from web access (internal backend use only)
    # Access via Docker network: http://immo_n8n:5678

    # WAHA - REMOVED from web access (internal backend use only)
    # Access via Docker network: http://immo_waha:3000

    # MinIO Console - REMOVED from web access (internal backend use only)
    # Access via Docker network: http://immo_minio:9001

    # =============================================
    # ADMIN SERVICES - Cloudflare Only + BasicAuth
    # =============================================

    # Grafana (Monitoring) - monitoring.immoguinee.com
    # SECURED: Cloudflare-only + admin-auth
    grafana-secure:
      rule: "Host(`monitoring.immoguinee.com`)"
      entryPoints:
        - websecure
      service: grafana
      tls: {}
      middlewares:
        - cloudflare-only@file
        - admin-auth@file
      priority: 100

    grafana-http:
      rule: "Host(`monitoring.immoguinee.com`)"
      entryPoints:
        - web
      middlewares:
        - https-redirect
      service: grafana
      priority: 1

    # pgAdmin (Database Admin) - pgadmin.immoguinee.com
    # SECURED: Cloudflare-only + admin-auth
    pgadmin-secure:
      rule: "Host(`pgadmin.immoguinee.com`)"
      entryPoints:
        - websecure
      service: pgadmin
      tls: {}
      middlewares:
        - cloudflare-only@file
        - admin-auth@file
      priority: 100

    pgadmin-http:
      rule: "Host(`pgadmin.immoguinee.com`)"
      entryPoints:
        - web
      middlewares:
        - https-redirect
      service: pgadmin
      priority: 1

    # Traefik Dashboard - traefik.immoguinee.com
    # SECURED: Cloudflare-only + admin-auth
    traefik-secure:
      rule: "Host(`traefik.immoguinee.com`)"
      entryPoints:
        - websecure
      service: api@internal
      tls: {}
      middlewares:
        - cloudflare-only@file
        - admin-auth@file
      priority: 100

    traefik-http:
      rule: "Host(`traefik.immoguinee.com`)"
      entryPoints:
        - web
      middlewares:
        - https-redirect
      service: api@internal
      priority: 1

    # Prometheus - prometheus.immoguinee.com
    # SECURED: Cloudflare-only + admin-auth
    prometheus-secure:
      rule: "Host(`prometheus.immoguinee.com`)"
      entryPoints:
        - websecure
      service: prometheus
      tls: {}
      middlewares:
        - cloudflare-only@file
        - admin-auth@file
      priority: 100

    prometheus-http:
      rule: "Host(`prometheus.immoguinee.com`)"
      entryPoints:
        - web
      middlewares:
        - https-redirect
      service: prometheus
      priority: 1

    # Alertmanager - alertmanager.immoguinee.com
    # SECURED: Cloudflare-only + admin-auth
    alertmanager-secure:
      rule: "Host(`alertmanager.immoguinee.com`)"
      entryPoints:
        - websecure
      service: alertmanager
      tls: {}
      middlewares:
        - cloudflare-only@file
        - admin-auth@file
      priority: 100

    alertmanager-http:
      rule: "Host(`alertmanager.immoguinee.com`)"
      entryPoints:
        - web
      middlewares:
        - https-redirect
      service: alertmanager
      priority: 1

  services:
    # All services use Docker Swarm naming: immo_<service>
    n8n:
      loadBalancer:
        servers:
          - url: "http://immo_n8n:5678"

    waha:
      loadBalancer:
        servers:
          - url: "http://immo_waha:3000"

    grafana:
      loadBalancer:
        servers:
          - url: "http://immo_grafana:3000"

    minio-console:
      loadBalancer:
        servers:
          - url: "http://immo_minio:9001"

    pgadmin:
      loadBalancer:
        servers:
          - url: "http://immo_pgadmin:80"

    prometheus:
      loadBalancer:
        servers:
          - url: "http://immo_prometheus:9090"

    alertmanager:
      loadBalancer:
        servers:
          - url: "http://immo_alertmanager:9093"

    # Note: traefik-dashboard removed - using api@internal instead

  middlewares:
    https-redirect:
      redirectScheme:
        scheme: https
        permanent: true
