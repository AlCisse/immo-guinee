# ===============================================
# Production Configuration - immoguinee.com
# Cloudflare Origin SSL with Full (strict) mode
# Works with both Docker Compose and Docker Swarm
# ===============================================

http:
  routers:
    # Frontend (Next.js) - HTTPS
    frontend-secure:
      rule: "Host(`immoguinee.com`) || Host(`www.immoguinee.com`)"
      entryPoints:
        - websecure
      service: frontend
      tls: {}
      middlewares:
        - compress
        - security-headers
      priority: 1

    # Backend API - HTTPS
    backend-secure:
      rule: "(Host(`immoguinee.com`) || Host(`www.immoguinee.com`)) && PathPrefix(`/api`)"
      entryPoints:
        - websecure
      service: backend
      tls: {}
      middlewares:
        - api-ratelimit
        - security-headers
      priority: 100

    # WebSocket (Laravel Reverb) - HTTPS
    websocket-secure:
      rule: "(Host(`immoguinee.com`) || Host(`www.immoguinee.com`)) && (PathPrefix(`/app`) || PathPrefix(`/apps`))"
      entryPoints:
        - websecure
      service: reverb
      tls: {}
      priority: 150

    # Storage - HTTPS
    storage-secure:
      rule: "(Host(`immoguinee.com`) || Host(`www.immoguinee.com`)) && PathPrefix(`/storage`)"
      entryPoints:
        - websecure
      service: backend
      tls: {}
      priority: 50

    # Well-known files (Universal Links / App Links) - HTTPS
    well-known-secure:
      rule: "(Host(`immoguinee.com`) || Host(`www.immoguinee.com`)) && PathPrefix(`/.well-known`)"
      entryPoints:
        - websecure
      service: backend
      tls: {}
      priority: 100

    # HTTP to HTTPS redirect
    http-redirect:
      rule: "Host(`immoguinee.com`) || Host(`www.immoguinee.com`)"
      entryPoints:
        - web
      middlewares:
        - https-redirect
      service: frontend
      priority: 1

  services:
    # Frontend service - Docker Swarm service name
    frontend:
      loadBalancer:
        servers:
          - url: "http://immog_frontend:3000"

    # Backend service - Docker Swarm service name
    backend:
      loadBalancer:
        servers:
          - url: "http://immog_nginx:80"

    # WebSocket (Laravel Reverb) service
    reverb:
      loadBalancer:
        servers:
          - url: "http://immog_reverb:8080"
        passHostHeader: true
        serversTransport: websocket-transport

  serversTransports:
    websocket-transport:
      forwardingTimeouts:
        dialTimeout: 30s
        responseHeaderTimeout: 0s
        idleConnTimeout: 90s

  middlewares:
    compress:
      compress:
        excludedContentTypes:
          - "text/event-stream"

    api-ratelimit:
      rateLimit:
        average: 100
        burst: 200
        period: 1m

    https-redirect:
      redirectScheme:
        scheme: https
        permanent: true
