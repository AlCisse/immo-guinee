# ===============================================
# Traefik Dynamic Configuration - Routers
# HTTP routing rules for services
# ===============================================

http:
  routers:
    # Backend API Router
    backend-api:
      rule: "Host(`api.immoguinee.gn`) || (Host(`immoguinee.gn`) && PathPrefix(`/api`))"
      entryPoints:
        - websecure
      service: backend-service
      middlewares:
        - security-headers
        - cors-headers
        - gzip-compression
        - rate-limit-api
        - circuit-breaker
      tls:
        certResolver: letsencrypt

    # Frontend Router
    frontend:
      rule: "Host(`immoguinee.gn`) || Host(`www.immoguinee.gn`)"
      entryPoints:
        - websecure
      service: frontend-service
      middlewares:
        - security-headers
        - gzip-compression
      tls:
        certResolver: letsencrypt

    # Laravel Echo WebSocket
    laravel-echo:
      rule: "Host(`ws.immoguinee.gn`) || (Host(`immoguinee.gn`) && PathPrefix(`/socket.io`))"
      entryPoints:
        - websecure
      service: echo-service
      middlewares:
        - security-headers
      tls:
        certResolver: letsencrypt

    # MinIO Console (Admin only)
    minio-console:
      rule: "Host(`minio.immoguinee.gn`)"
      entryPoints:
        - websecure
      service: minio-service
      middlewares:
        - admin-whitelist
        - security-headers
      tls:
        certResolver: letsencrypt

    # Grafana Dashboard (Admin only)
    grafana:
      rule: "Host(`grafana.immoguinee.gn`)"
      entryPoints:
        - websecure
      service: grafana-service
      middlewares:
        - admin-whitelist
        - security-headers
      tls:
        certResolver: letsencrypt

    # n8n Workflows (Admin only)
    n8n:
      rule: "Host(`n8n.immoguinee.gn`)"
      entryPoints:
        - websecure
      service: n8n-service
      middlewares:
        - admin-whitelist
        - security-headers
      tls:
        certResolver: letsencrypt

  # Services
  services:
    backend-service:
      loadBalancer:
        servers:
          - url: "http://nginx:80"
        healthCheck:
          path: "/api/health"
          interval: "30s"
          timeout: "5s"
        passHostHeader: true

    frontend-service:
      loadBalancer:
        servers:
          - url: "http://nginx:80"
        passHostHeader: true

    echo-service:
      loadBalancer:
        servers:
          - url: "http://laravel-echo:6001"
        passHostHeader: true

    minio-service:
      loadBalancer:
        servers:
          - url: "http://minio:9001"

    grafana-service:
      loadBalancer:
        servers:
          - url: "http://grafana:3000"

    n8n-service:
      loadBalancer:
        servers:
          - url: "http://n8n:5678"
